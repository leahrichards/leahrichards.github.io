YUI.add("search-photos-route",function(e,t){function r(e){r.superclass.constructor.call(this,e)}var n=require("lib/flog")(t);e.Routes[this.name]=r,e.extend(r,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r={},i=this,s,o=!0,u=!0,a=!1,f,l,c,h={};r.apiParams=this.processRequest(t),r.viewerNsid=t.probableUser||this.appContext.getViewer().nsid,s=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],!s&&!this.appContext.flipper.isFlipped("enable-slender-advanced-search")&&(o=!1),r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]&&r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]&&(u=!1,o=!1),t.query&&t.query.advanced===1&&(a=!0);switch(r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewType]){case"thumbs":f=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.thumbs;break;case"tiles":f=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles;break;case"justified":f=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.justified}return c=this.generateUnifiedSubviewParams(r),c.everyone&&(h.everyone=this.appContext.getModel("search-photos-lite-models",c.everyone.id,c.everyone.fetchParams)),c.yours&&(h.yours=this.appContext.getModel("search-photos-lite-models",c.yours.id,c.yours.fetchParams)),c.contacts&&(h.contacts=this.appContext.getModel("search-photos-lite-models",c.contacts.id,c.contacts.fetchParams)),c.albums&&(h.albums=this.appContext.getModel("search-sets-models",c.albums.id,c.albums.fetchParams)),!f&&r.viewerNsid&&(h.viewerPrefs=this.appContext.getModel("person-preferences-models",r.viewerNsid)),l=t.query&&parseFloat(t.query.row_height)||1,l=Math.max(.5,Math.min(4,l)),e.FlickrPromise(h).then(function(t){f||(t.viewerPrefs?f=t.viewerPrefs.getValue("unifiedSearchViewPref"):f=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT),i.appContext.flipper.isFlipped("search-tiles")||f===e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles&&(f=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT);var n=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],s=i.intlMessage({intlName:"search.SEARCH"});return n!==undefined&&(s+=": "+n),e.Promise.resolve({view:"search-photos-unified-page-view",params:{unifiedSubviewParams:c,searchType:e.SearchUrl.searchTypes.PHOTOS,searchTerm:n,modelParams:r,showTools:o,showAdvanced:u,openAdvanced:a,showSort:o,viewType:f,rowHeightMod:l},layout:"scrolling",title:s})},function(t){n.error({err:t});var s=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],o=i.intlMessage({intlName:"search.SEARCH"});return s!==undefined&&(o+=": "+s),e.Promise.resolve({view:"search-photos-unified-page-view",params:{searchTerm:s,apiFailed:!0,modelParams:r},title:o})})},generateUnifiedSubviewParams:function(t){var n={},r=t.apiParams,i;return e.SearchHelper.isParameterlessSearch(r)?n:(this.shouldPerformEveryoneSearch(t,r)&&(i=new e.SearchUrl(r,this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.everyone={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:25}}),this.shouldPerformYoursSearch(t,r)&&(i=new e.SearchUrl(e.merge({user_id:t.viewerNsid,sort:e.SearchHelper.API_SORT_OPTIONS.dateTaken},r),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.yours={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformContactsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{contacts:"all"}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.contacts={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformAlbumsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{user_id:t.viewerNsid}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.albums={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),n)},shouldPerformEveryoneSearch:function(t,n){return!n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]||!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformYoursSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformContactsSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformAlbumsSearch:function(t,n){return!t.viewerNsid||!n[e.SearchHelper.API.text]?!1:parseInt(n[e.SearchHelper.API.marketplace])?!1:n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]?!0:!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},processRequest:function(t){var n={};return n=e.merge(t.query,e.SearchHelper.mapRouteParamsToAPI(t.params)),n=e.SearchHelper.mapClassicSearchToAPI(n,this.appContext),e.SearchHelper.addParamDefaults(n),YUI.Env.isServer&&e.SearchHelper.unescapeParameters(n),n}}),e.mix(r.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","search-helper","localizable","search-photos-lite-models","search-sets-models","url","search-url","search-photos-unified-page-view","person-preferences-models"],langBundles:["search"]});
